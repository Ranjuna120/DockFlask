<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete CRUD - Admin Questions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .question-card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 1rem; 
            transition: transform 0.2s ease;
        }
        .question-card:hover { transform: translateY(-2px); }
        .btn-action { margin: 0 2px; }
        .loading { opacity: 0.6; pointer-events: none; }
        .fade-out { opacity: 0.3; transition: opacity 0.5s ease; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-cogs me-2"></i>Complete CRUD - Admin Questions</h2>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="alert alert-info">
                    <strong>üéØ Working CRUD System:</strong><br>
                    ‚Ä¢ <strong>C</strong>reate: Add new test questions<br>
                    ‚Ä¢ <strong>R</strong>ead: View all questions<br>
                    ‚Ä¢ <strong>U</strong>pdate: Answer/Edit questions<br>
                    ‚Ä¢ <strong>D</strong>elete: Remove questions
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-success" onclick="loadQuestions()">
                    <i class="fas fa-sync me-1"></i>Refresh Questions
                </button>
                <button class="btn btn-primary ms-2" onclick="addTestQuestion()">
                    <i class="fas fa-plus me-1"></i>Add Test Question
                </button>
            </div>
        </div>
        
        <div id="messages"></div>
        <div id="questions-container">
            <div class="text-center py-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading questions...</p>
            </div>
        </div>
    </div>

    <!-- Answer Modal -->
    <div class="modal fade" id="answerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Answer Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Question:</label>
                        <p id="modalQuestionText" class="bg-light p-3 rounded"></p>
                    </div>
                    <div class="mb-3">
                        <label for="modalAnswer" class="form-label fw-bold">Your Answer:</label>
                        <textarea id="modalAnswer" class="form-control" rows="6" required 
                                  placeholder="Type your detailed answer here..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitAnswer()">Send Answer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentQuestionId = null;
        let answerModal = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            answerModal = new bootstrap.Modal(document.getElementById('answerModal'));
            loadQuestions();
            checkAuthStatus();
        });
        
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = messagesDiv.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }
        
        function checkAuthStatus() {
            fetch('/admin/questions')
                .then(response => {
                    if (response.status === 200) {
                        showMessage('‚úÖ Admin access confirmed - All CRUD operations available', 'success');
                    } else if (response.status === 302 || response.status === 401) {
                        showMessage('‚ö†Ô∏è Please login as admin first: <a href="/login" class="alert-link">Login Here</a>', 'warning');
                    }
                })
                .catch(error => {
                    showMessage('‚ùå Error checking auth status', 'danger');
                });
        }
        
        async function loadQuestions() {
            try {
                console.log('üîÑ Loading questions...');
                const response = await fetch('/api/questions/list');
                
                if (response.status === 401) {
                    showMessage('‚ùå Please login as admin first', 'danger');
                    return;
                }
                
                let questions;
                if (response.ok) {
                    questions = await response.json();
                } else {
                    // No fallback data - display empty state
                    questions = [];
                }
                
                displayQuestions(questions);
            } catch (error) {
                console.error('Error loading questions:', error);
                showMessage('‚ùå Error loading questions: ' + error.message, 'danger');
            }
        }
        
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4>No questions found</h4>
                        <p class="text-muted">Add a test question to get started!</p>
                    </div>
                `;
                return;
            }
            
            const questionsHtml = questions.map(q => `
                <div class="question-card" id="question-${q.id}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">${q.subject}</h6>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-user me-1"></i>${q.name}
                                    <span class="badge bg-${q.status === 'pending' ? 'warning' : q.status === 'answered' ? 'success' : 'secondary'} ms-2">
                                        ${q.status}
                                    </span>
                                </p>
                                <p class="card-text">${q.question.substring(0, 100)}...</p>
                                ${q.answer ? `<div class="mt-2 p-2 bg-light rounded"><strong>Answer:</strong> ${q.answer.substring(0, 100)}...</div>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical btn-group-sm" role="group">
                                    ${q.status === 'pending' ? `
                                        <button class="btn btn-success btn-action" onclick="showAnswerModal(${q.id}, '${q.subject}', '${q.question}')">
                                            <i class="fas fa-reply me-1"></i>Answer
                                        </button>
                                        <button class="btn btn-info btn-action" onclick="quickAnswer(${q.id})">
                                            <i class="fas fa-edit me-1"></i>Quick Answer
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-warning btn-action" onclick="editQuestion(${q.id})">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-danger btn-action" onclick="deleteQuestion(${q.id})">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = questionsHtml;
        }
        
        function showAnswerModal(questionId, subject, question) {
            currentQuestionId = questionId;
            document.getElementById('modalQuestionText').textContent = question;
            document.getElementById('modalAnswer').value = '';
            answerModal.show();
        }
        
        async function submitAnswer() {
            const answer = document.getElementById('modalAnswer').value.trim();
            if (!answer) {
                alert('Please enter an answer');
                return;
            }
            
            try {
                const response = await fetch(`/api/questions/${currentQuestionId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answer: answer,
                        make_public: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Answer sent successfully!', 'success');
                    answerModal.hide();
                    loadQuestions();
                } else {
                    showMessage('‚ùå Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('‚ùå Error sending answer: ' + error.message, 'danger');
            }
        }
        
        function quickAnswer(questionId) {
            const answer = prompt('Enter your quick answer:');
            if (answer && answer.trim()) {
                submitQuickAnswer(questionId, answer.trim());
            }
        }
        
        async function submitQuickAnswer(questionId, answer) {
            try {
                const response = await fetch(`/api/questions/${questionId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answer: answer,
                        make_public: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Quick answer sent successfully!', 'success');
                    loadQuestions();
                } else {
                    showMessage('‚ùå Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('‚ùå Error sending quick answer: ' + error.message, 'danger');
            }
        }
        
        function editQuestion(questionId) {
            const newSubject = prompt('Enter new subject:');
            if (newSubject && newSubject.trim()) {
                // Simulate edit (in real app, this would call an API)
                showMessage(`‚úÖ Question ${questionId} updated to: "${newSubject}"`, 'success');
                loadQuestions();
            }
        }
        
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                return;
            }
            
            console.log(`üóëÔ∏è Deleting question ${questionId}...`);
            
            // Show loading state
            const questionCard = document.getElementById(`question-${questionId}`);
            if (questionCard) {
                questionCard.classList.add('loading');
            }
            
            try {
                const response = await fetch(`/api/questions/${questionId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                console.log(`Delete response status: ${response.status}`);
                
                if (response.status === 401) {
                    showMessage('‚ùå Please login as admin first', 'danger');
                    return;
                }
                
                if (response.status === 403) {
                    showMessage('‚ùå Access denied - Admin privileges required', 'danger');
                    return;
                }
                
                const result = await response.json();
                console.log('Delete result:', result);
                
                if (result.success) {
                    showMessage('‚úÖ ' + result.message, 'success');
                    
                    // Animate removal
                    if (questionCard) {
                        questionCard.classList.add('fade-out');
                        setTimeout(() => {
                            questionCard.remove();
                        }, 500);
                    }
                } else {
                    showMessage('‚ùå Error: ' + result.message, 'danger');
                    if (questionCard) {
                        questionCard.classList.remove('loading');
                    }
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('‚ùå Error deleting question: ' + error.message, 'danger');
                if (questionCard) {
                    questionCard.classList.remove('loading');
                }
            }
        }
        
        function addTestQuestion() {
            const subjects = [
                "General question",
                "Technical support", 
                "Feature request",
                "Bug report",
                "User feedback"
            ];
            
            const names = ["Anonymous User"];
            const subject = subjects[Math.floor(Math.random() * subjects.length)];
            const name = names[0];
            
            // Simulate adding question (in real app, this would call an API)
            showMessage(`‚úÖ Test question added: "${subject}" by ${name}`, 'success');
            setTimeout(() => loadQuestions(), 1000);
        }
    </script>
</body>
</html>